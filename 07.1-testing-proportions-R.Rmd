# Testing proportions

## Pearson’s chi-squared test

### Individual data

We will demonstrate how to use R to conduct a Pearson chi-squared test using Worked Example 7.1.

```{r}
library(haven)
library(labelled)

nausea <- readRDS("data/examples/Example_7.1.rds")

head(nausea)
```
These data have been labelled in Stata, and we use the `unlabelled` function to convert the labelled data into factors. We can confirm that the variables are stored as factors using the `str` function to examine the structure of the variables, and the `table` function to produce a frequency table.

```{r}
str(nausea$group)
table(nausea$group)

str(nausea$side_effect)
table(nausea$side_effect)
```

To conduct a chi-square test on these data, we first construct a table and view the expected frequencies.

```{r}
tab <- table(nausea$group, nausea$side_effect)
tab

chisq.test(tab)$expected
```

After confirming that there are no cells with small expected frequencies, we can conduct the chi-square test. By default, R conducts a chi-square test with a continuity correction. To obtain an identical result to that produced by Stata, we use the `correct=FALSE` statement.

```{r}
chisq.test(tab)
chisq.test(tab, correct=FALSE)
```

The last line labelled Pearson chi2(1) reports the appropriate Chi-squared test statistic which has a value of 7.862 with 1 degree of freedom and a P value of 0.005.

```{r}
fisher.test(tab)
```


### Summarised data
When you only have the cross-tabulated data, you can enter the summarised data manually. The TextToTable function in the DescTools library is useful here:

```{r}
library(DescTools)

text <- "
           NoNausea, Nausea
Placebo,         46, 4
ActiveDrug,      35, 15"

table <- TextToTable(text, header=TRUE, sep=",", dimnames=c("Group", "SideEffect"))

chisq.test(table)$expected
chisq.test(table)
chisq.test(table, correct=FALSE)
```


## Chi-squared test for tables larger than 2-by-2
Use the data in `Example_7.2.rds`. We use similar steps as described above for a 2-by-2 table.

```{r}
allergy <- readRDS("data/examples/Example_7.2.rds")

head(allergy)
```

```{r}
tab_allergy <- table(allergy$allergy_severity, allergy$sex)
tab_allergy

chisq.test(tab_allergy)$expected
chisq.test(tab_allergy)

jmv::contTables(allergy, allergy_severity, sex, pcCol=TRUE)
```


## McNemar’s test for paired proportions

To perform this test in R, we will use the dataset `Example_7.3.rds`. 

```{r}
drug <- readRDS("data/examples/Example_7.3.rds")

head(drug)
```


Responses to each drug should be in separate variables in the dataset as shown in Table 7.2 using the `tabulate2` command (**Statistics > Summaries, tables, and tests > Frequency tables > Two-way table with measures of association**). In the tabulate2 dialog box, tick **Relative frequencies** under **Cell contents** as shown below.

```{r}
tab_drug <- table(drug$druga, drug$drugb)
tab_drug

prop.table(tab_drug)
```


To perform the McNemar’s test, go to **Statistics > Epidemiology and related > Tables for epidemiologists > Matched case-control studies**. In the `mcc` dialog box, select the variable `drugb` as the **Exposed case variable** and `druga` as the **Exposed control variable** as shown below.

```{r}
mcnemar.test(tab_drug)

epibasix::mcNemar(tab_drug)$rd
epibasix::mcNemar(tab_drug)$rd.CIL
epibasix::mcNemar(tab_drug)$rd.CIU
```

