# Testing proportions

## Pearson’s chi-squared test

### Individual data

We will demonstrate how to use R to conduct a Pearson chi-squared test using Worked Example 7.1.

```{r}
library(jmv)

nausea <- readRDS("data/examples/Example_7.1.rds")

head(nausea)

str(nausea$group)
str(nausea$side_effect)
```

The columns `group` and `side_effect` have been entered as factors, with "Placebo" and "No nausea" as the first levels. We should use the `relevel()` command to re-order the factor levels.

```{r}
nausea$group <- releve(nausea$group, ref="Active")
nausea$side_effect <- releve(nausea$side_effect, ref="Nausea")

str(nausea$group)
str(nausea$side_effect)
```

After confirming the factors are appropriately defined, we can construct our 2-by-2 table and view the expected frequencies.

```{r}
contTables(data=nausea,
           rows=group, cols=side_effect,
           exp=TRUE)
```

After confirming that there are no cells with small expected frequencies, we can interpret the chi-square test. The last section reports the chi-squared test statistic which has a value of 7.86 with 1 degree of freedom and a P-value of 0.005.

If there are small values of expected frequencies, Fisher's exact test can be requested using `fisher = TRUE`:

```{r}
contTables(data=nausea,
           rows=group, cols=side_effect,
           fisher = TRUE)
```

### Summarised data
When you only have the summarised date (for example, the cross-tabulated data), you need to enter the summarised data manually. As we did in Module 6, the 2-by-2 table can be entered as four lines of data:

```{r}
drug_aggregated <- data.frame(
  group = c("Active", "Active", "Placebo", "Placebo"),
  side_effect = c("Nausea", "No nausea", "Nausea", "No nausea"),
  n = c(15, 35, 4, 46)
)
```

The `contTables()` function is used in the usual way, specifying `count=n`.

## Chi-squared test for tables larger than 2-by-2
Use the data in `Example_7.2.rds`. We use similar steps as described above for a 2-by-2 table.

```{r}
allergy <- readRDS("data/examples/Example_7.2.rds")

head(allergy)
```

```{r}
contTables(data=allergy, 
           rows=allergy_severity, cols=sex, 
           pcCol=TRUE)
```


## McNemar’s test for paired proportions

To perform this test in R, we will use the dataset `Example_7.3.rds`. 

```{r}
drug <- readRDS("data/examples/Example_7.3.rds")

head(drug)
```

Responses to each drug should be in separate variables in the dataset as shown in Table 7.2 using the `tabulate2` command (**Statistics > Summaries, tables, and tests > Frequency tables > Two-way table with measures of association**). In the tabulate2 dialog box, tick **Relative frequencies** under **Cell contents** as shown below.

```{r}
tab_drug <- table(drug$druga, drug$drugb)
tab_drug

prop.table(tab_drug)
```


To perform the McNemar’s test, go to **Statistics > Epidemiology and related > Tables for epidemiologists > Matched case-control studies**. In the `mcc` dialog box, select the variable `drugb` as the **Exposed case variable** and `druga` as the **Exposed control variable** as shown below.

```{r}
mcnemar.test(tab_drug)

epibasix::mcNemar(tab_drug)$rd
epibasix::mcNemar(tab_drug)$rd.CIL
epibasix::mcNemar(tab_drug)$rd.CIU
```

